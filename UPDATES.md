# 🚀 v2.0 대규모 업데이트: LangGraph 기반 능동형 에이전트 전환

이번 업데이트는 기존의 수동적인 SQL 생성기를 넘어, **LangGraph(랭그래프)** 라이브러리의 강력한 상태 관리 기능을 100% 활용하여 **기억력과 판단력을 갖춘 지능형 에이전트**로 진화시키는 것에 초점을 맞추었습니다.

---

## 💡 1. 핵심 기술 도입 (Key Technologies)

### 🔹 LangGraph Checkpointer (`AsyncPostgresSaver`)
- **Before**: 매번 API 요청 시 이전 대화 내역 전체를 DB에서 긁어와 문자열로 합쳐서 LLM에게 던져주는 방식 (Prompt Injection). 서버가 죽거나 재시작하면 진행 중이던 대화 상태가 유실될 위험이 컸습니다.
- **After**: **LangGraph 내장 체크포인트 시스템** 도입.
  - `thread_id` 하나로 대화 히스토리, 생성된 SQL 쿼리, 실행 결과 데이터, 에러 메시지 등 **에이전트의 모든 상태(State)를 DB에 영구 저장**합니다.
  - 사용자가 브라우저를 껐다 켜거나 서버를 재시작해도, **마지막 대화 지점에서 완벽하게 복원(Resume)**됩니다.

### 🔹 조건부 엣지 (Conditional Edge) & 분기 처리
- **Before**: 사용자 질문 -> SQL 생성 -> 실행이라는 단일 선형 구조로만 동작하여, 질문이 모호해도 무조건 SQL을 만들려다 실패했습니다.
- **After**: **의도 분류(Intent Classification)** 노드 도입.
  - 질문이 들어오면 먼저 **[SQL, General, Clarification]** 중 어떤 의도인지 판단하여 실행 경로를 동적으로 바꿉니다.
  - "안녕", "고마워" 같은 인사에는 SQL을 생성하지 않고 즉시 친절한 답변을 생성합니다.

---

## 🛠️ 2. 기능적 강화 (Functional Enhancements)

### 🔄 멀티턴(Multi-turn) 대화 능력 강화
단발성 질문만 처리하던 기존과 달리, 사람처럼 꼬리에 꼬리를 무는 대화가 가능해졌습니다.

1. **문맥 기반 의도 파악**:
   - "전체 기간", "모든 데이터"라고 말하면, 이전 쿼리의 시간 제약에 얽매이지 않고 **`ALL` 토큰**을 생성하여 상속 로직을 스스로 끊고 전체를 조회합니다.
   - "2.5일" 같은 약어 날짜도 정확히 파싱합니다.

2. **똑똑한 상속(Smart Inheritance)**:
   - "상위 5개만 보여줘"라고 하면 "무엇의 상위 5개?"라고 되묻지 않고, **직전 실행했던 SQL 쿼리의 조건과 테이블을 그대로 가져와서** `LIMIT` 조건만 추가하여 재실행합니다.

### 🙋 휴먼-인-더-루프 (HITL) & 역질문
에이전트가 모르는 것을 아는 척하지 않고, 사용자에게 되물어보는 능력이 생겼습니다.

- **Before**: 정보가 부족하면 에이전트가 임의로 가정하고 이상한 SQL을 만들거나 "정보 부족" 에러를 뱉었습니다.
- **After**: **Interrupt(중단) 메커니즘** 도입.
  - 필수 정보(측정 지표 등)가 누락되었다고 판단되면, SQL 생성 단계로 넘어가지 않고 **즉시 멈추어(Interrupt)** 구체적인 역질문을 던집니다.
  - 사용자가 대답을 하면 그 정보를 바탕으로 **중단된 지점부터 자연스럽게 작업을 재개**합니다.

### 📝 결과 요약 및 일반 대화 지원
단순히 표만 보여주는 것이 아니라, 데이터가 의미하는 바를 해석해 줍니다.

- **결과 요약(Data Interpretation)**:
  - SQL 실행 결과(표 데이터)를 LLM이 분석하여 "평균 CPU 사용률은 10%이며 안정적입니다"와 같이 **자연어 보고서**를 작성해 줍니다.
  
- **일반 대화(General Chat)**:
  - SQL과 무관한 시스템 사용법 질문이나 가벼운 대화도 에이전트가 맥락에 맞게 자연스럽게 받아줍니다.

---

## 📊 요약: Before vs After

| 구분 | Before (v1.0) | After (v2.0 LangGraph Native) |
| :--- | :--- | :--- |
| **상태 관리** | 수동 DB 조회 및 프롬프트 주입 | **Checkpointer 자동 저장 및 복원** |
| **대화 흐름** | 선형적 (질문 -> SQL) | **동적 분기 (조건에 따라 경로 변경)** |
| **정보 부족 시** | 에러 발생 또는 환각(Hallucination) | **즉시 멈추고 역질문 (HITL)** |
| **일반 대화** | 불가능 (SQL 생성 실패로 처리) | **가능 (별도 경로로 우회 처리)** |
| **결과물** | 단순 데이터 표(Table) | **데이터 표 + 인사이트 요약 보고서** |
