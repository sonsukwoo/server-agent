version: '3.8'

services:
  # Backend Agent (Includes MCP Servers)
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: server-agent-backend
    env_file:
      - ./backend/.env
    network_mode: host
    environment:
      - TZ=Asia/Seoul
      - MCP_TRANSPORT=http
      - MCP_POSTGRES_URL=http://127.0.0.1:9010
      - MCP_QDRANT_URL=http://127.0.0.1:9012
    # 멀티 워커로 동시성 처리 능력 향상 (CPU 바운드 작업 분산)
    command: [ "uvicorn", "src.api.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4" ]
    volumes:
      - ./backend:/app
    depends_on:
      - mcp-postgres
      - mcp-qdrant

  # MCP - Postgres (containerized)
  mcp-postgres:
    build:
      context: ./mcp_servers/postgres
      dockerfile: Dockerfile
    container_name: mcp-postgres
    network_mode: host
    env_file:
      - ./backend/.env
    # host mode에서는 포트를 호스트에 직접 노출합니다.
    command: [ "uvicorn", "server:http_app", "--host", "127.0.0.1", "--port", "9010" ]

  # MCP - Qdrant (Search + Embeddings)
  mcp-qdrant:
    build:
      context: ./mcp_servers/qdrant
      dockerfile: Dockerfile
    container_name: mcp-qdrant
    network_mode: host
    env_file:
      - ./backend/.env
    # host mode에서는 포트를 호스트에 직접 노출합니다.
    command: [ "uvicorn", "server:http_app", "--host", "127.0.0.1", "--port", "9012" ]

  # Frontend (Vite + React)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: server-agent-frontend
    network_mode: host
    depends_on:
      - backend
