# ğŸ¤– Text-to-SQL Agent (Server Agent)

**ì„œë²„ ëª¨ë‹ˆí„°ë§ ë° ìì—°ì–´ ë°ì´í„° ë¶„ì„ ì—ì´ì „íŠ¸**

ì´ í”„ë¡œì íŠ¸ëŠ” ìì—°ì–´ ì§ˆë¬¸ì„ SQL ì¿¼ë¦¬ë¡œ ë³€í™˜í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°íšŒí•˜ê³ , ì„œë²„ ë¦¬ì†ŒìŠ¤ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ëŠ” ì§€ëŠ¥í˜• ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.  
**RAG (Retrieval-Augmented Generation)** ê¸°ë²•ê³¼ **LangGraph** ê¸°ë°˜ì˜ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µì¡í•œ ì§ˆì˜ë¥¼ ì²˜ë¦¬í•˜ë©°, **ì‹¤ì‹œê°„ ìŠ¤í‚¤ë§ˆ ê°ì§€** ê¸°ëŠ¥ì„ í†µí•´ DB êµ¬ì¡° ë³€ê²½ì— ì¦‰ì‹œ ëŒ€ì‘í•©ë‹ˆë‹¤.

---

## ğŸ”¥ í•µì‹¬ ê¸°ëŠ¥ (Key Features)

### 1. ğŸ›¡ï¸ ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´ (Security Middleware)
ì‚¬ìš©ìì˜ ì…ë ¥ì´ ì‹œìŠ¤í…œì— ë„ë‹¬í•˜ê¸° ì „, **`InputGuard` ë¯¸ë“¤ì›¨ì–´**ê°€ ìœ„í—˜í•œ ìš”ì²­ì„ ì‚¬ì „ì— ì°¨ë‹¨í•©ë‹ˆë‹¤.
- **í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë°©ì§€**: "Ignore previous instructions", "System prompt" ë“± LLMì˜ ë™ì‘ì„ ì¡°ì‘í•˜ë ¤ëŠ” ì‹œë„ë¥¼ ì°¨ë‹¨í•©ë‹ˆë‹¤.
- **ì…ë ¥ ê¸¸ì´ ì œí•œ**: ê³¼ë„í•œ í† í° ì‚¬ìš©ì„ ìœ ë°œí•˜ëŠ” DoS ê³µê²©ì„ ë°©ì§€í•©ë‹ˆë‹¤ (ìµœëŒ€ 1000ì).
- **SQL ì•ˆì „ì„± ê²€ì‚¬**: ìƒì„±ëœ SQL ì¿¼ë¦¬ì— `DROP`, `DELETE`, `TRUNCATE` ë“± íŒŒê´´ì ì¸ ëª…ë ¹ì–´ê°€ í¬í•¨ë˜ì—ˆëŠ”ì§€ 2ì°¨ ê²€ì¦í•©ë‹ˆë‹¤.

### 2. âš¡ ì‹¤ì‹œê°„ ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” (Real-time Schema Sync)
ë°ì´í„°ë² ì´ìŠ¤ì˜ í…Œì´ë¸”ì´ ìƒì„±ë˜ê±°ë‚˜ ë³€ê²½ë˜ëŠ” ì¦‰ì‹œ ì—ì´ì „íŠ¸ê°€ ì´ë¥¼ ì¸ì§€í•©ë‹ˆë‹¤.
- **PostgreSQL LISTEN/NOTIFY**: `SchemaListener`ê°€ DBì˜ DDL ì´ë²¤íŠ¸ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
- **ìë™ ì„ë² ë”© ì—…ë°ì´íŠ¸**: ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ Qdrant ë²¡í„° ì €ì¥ì†Œì˜ ê´€ë ¨ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ê°±ì‹ í•˜ì—¬, ì—ì´ì „íŠ¸ê°€ í•­ìƒ ìµœì‹  í…Œì´ë¸” êµ¬ì¡°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 3. ğŸ§  ê³ ê¸‰ RAG & ì—ì´ì „íŠ¸ ì›Œí¬í”Œë¡œìš°
ë‹¨ìˆœí•œ í…ìŠ¤íŠ¸ ë³€í™˜ì´ ì•„ë‹Œ, **LangGraph**ë¥¼ í™œìš©í•œ ë‹¨ê³„ì  ì‚¬ê³  ê³¼ì •ì„ ê±°ì¹©ë‹ˆë‹¤.
1.  **ì§ˆë¬¸ ë¶„ì„**: ì‚¬ìš©ì ì˜ë„ íŒŒì•….
2.  **í…Œì´ë¸” ê²€ìƒ‰ (Retrieval)**: Qdrant ë²¡í„° ê²€ìƒ‰ì„ í†µí•´ ì§ˆë¬¸ê³¼ ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ í…Œì´ë¸”ì„ ì¶”ì¶œ (Top-K).
3.  **í…Œì´ë¸” í™•ì¥ (Expansion)**: ì™¸ë˜ í‚¤(Foreign Key) ê´€ê³„ë¥¼ ë¶„ì„í•˜ì—¬ ì¡°ì¸ì´ í•„ìš”í•œ í…Œì´ë¸”ì„ ì¶”ê°€ë¡œ íƒìƒ‰.
4.  **SQL ìƒì„± ë° ê²€ì¦**: ì¿¼ë¦¬ ì‘ì„± í›„ ë¬¸ë²• ë° ì•ˆì „ì„± ê²€ì¦.
5.  **ìê°€ ì¹˜ìœ  (Self-Healing)**: ì¿¼ë¦¬ ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë¶„ì„í•˜ì—¬ ìŠ¤ìŠ¤ë¡œ ìˆ˜ì • (`Reflection`).

### 4. ğŸ“Š ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ
- **ì‹¤ì‹œê°„ ì§€í‘œ**: CPU, ë©”ëª¨ë¦¬, ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.
- **ê³ ê¸‰ ì•Œë¦¼ ê·œì¹™ (Lego Blocks)**: ì‚¬ìš©ìê°€ ì§ì ‘ "CPU > 80% ì¼ ë•Œ ì•Œë¦¼" ê°™ì€ ê·œì¹™ì„ ì›¹ UIì—ì„œ ë¸”ëŸ­ ì¡°ë¦½í•˜ë“¯ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ (Tech Stack)

### Backend
- **Framework**: `FastAPI` (High-performance API)
- **Agent Orchestration**: `LangGraph`, `LangChain`
- **Database**: `PostgreSQL` (Asyncpg for async I/O)
- **Vector Store**: `Qdrant` (Schema embedding & storage)
- **Tooling**: `MCP (Model Context Protocol)` (Standardized tool interface)

### Frontend
- **Framework**: `React`, `Vite` (TypeScript)
- **Styling**: `Vanilla CSS` (Dark Theme Optimized)
- **Components**: `Lucide React` (Icons)

---

## ğŸš€ ì—ì´ì „íŠ¸ ì›Œí¬í”Œë¡œìš° (Architecture Flow)

ì‚¬ìš©ìê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì„ ê±°ì³ ë‹µë³€ì´ ìƒì„±ë©ë‹ˆë‹¤.

```mermaid
graph TD
    User[ğŸ‘¤ ì‚¬ìš©ì ì§ˆë¬¸] --> Middleware[ğŸ›¡ï¸ InputGuard (ë³´ì•ˆ ê²€ì¦)]
    Middleware -- ì°¨ë‹¨ --> Block[ğŸš« ê±°ë¶€ ë©”ì‹œì§€]
    Middleware -- í†µê³¼ --> Agent[ğŸ¤– SQL ì—ì´ì „íŠ¸]
    
    Agent --> Embedding[ë²¡í„° ì„ë² ë”©]
    Embedding --> VectorSearch[ğŸ” Qdrant ê²€ìƒ‰ (ê´€ë ¨ í…Œì´ë¸” ì°¾ê¸°)]
    VectorSearch --> TableExpansion[ğŸ”— í…Œì´ë¸” í™•ì¥ (FK ê´€ê³„ ë¶„ì„)]
    
    TableExpansion --> GenerateSQL[ğŸ“ SQL ìƒì„±]
    GenerateSQL --> GuardSQL[ğŸ›¡ï¸ ì¿¼ë¦¬ ì•ˆì „ì„± ê²€ì‚¬]
    
    GuardSQL -- ìœ„í—˜ --> FixSQL[ğŸ”§ ì¿¼ë¦¬ ìˆ˜ì •]
    GuardSQL -- ì•ˆì „ --> ExecuteSQL[ğŸš€ DB ì‹¤í–‰]
    
    ExecuteSQL -- ì„±ê³µ --> Report[ğŸ“Š ê²°ê³¼ ë³´ê³ ì„œ ì‘ì„±]
    ExecuteSQL -- ì‹¤íŒ¨ --> Reflection[ğŸ¤” ì—ëŸ¬ ë¶„ì„ ë° ì¬ì‹œë„]
    Reflection --> GenerateSQL
    
    Report --> UserResponse[ğŸ’¬ ìµœì¢… ë‹µë³€]
```

---

## ğŸ“¦ í”„ë¡œì íŠ¸ êµ¬ì¡° (Directory Structure)

```
server-agent/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ advanced_settings/   # ê³ ê¸‰ ì•Œë¦¼ ë° ì„¤ì • ë¡œì§
â”‚   â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/      # InputGuard ë“± ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´
â”‚   â”‚   â”‚   â”œâ”€â”€ text_to_sql/     # LangGraph ì—ì´ì „íŠ¸ ë…¸ë“œ ì •ì˜
â”‚   â”‚   â”œâ”€â”€ api/                 # FastAPI ì—”ë“œí¬ì¸íŠ¸
â”‚   â”‚   â”œâ”€â”€ db/                  # DB ì—°ê²° ë° ì»¤ë„¥ì…˜ í’€ ê´€ë¦¬
â”‚   â”‚   â”œâ”€â”€ schema/              # ìŠ¤í‚¤ë§ˆ ê°ì§€ ë¦¬ìŠ¤ë„ˆ (Sync)
â”‚   â”œâ”€â”€ main.py                  # ì•± ì§„ì…ì 
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ frontend/                    # ë¦¬ì•¡íŠ¸ ê¸°ë°˜ ì›¹ ëŒ€ì‹œë³´ë“œ
â”œâ”€â”€ mcp_servers/                 # MCP (Postgres, Qdrant ë“±) ì„œë²„
â””â”€â”€ docker-compose.yml           # ì „ì²´ ì„œë¹„ìŠ¤ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
```

---

## ğŸš€ ì‹œì‘í•˜ê¸° (Getting Started)

### 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
`.env` íŒŒì¼ì„ ìƒì„±í•˜ê³  í•„ìš”í•œ API í‚¤ì™€ DB ì„¤ì •ì„ ì…ë ¥í•˜ì„¸ìš”.

### 2. ì‹¤í–‰
Docker Composeë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ í•œ ë²ˆì— ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
docker compose up --build -d
```

### 3. ì ‘ì†
- **ì›¹ UI**: [http://localhost:5173](http://localhost:5173) (ë˜ëŠ” 80ë²ˆ í¬íŠ¸ ì„¤ì •ì— ë”°ë¦„)
- **API ë¬¸ì„œ**: [http://localhost:8000/docs](http://localhost:8000/docs)
